<!DOCTYPE html><html lang="en-US"><body> <script> var elements = document.querySelectorAll('p'); Array.prototype.forEach.call(elements, function(el, i){ if(el.innerHTML=='[expand]') { var parentcontent = el.parentNode.innerHTML.replace('<p>[expand]</p>','<div class="expand" style="display: none; height: 0; overflow: hidden;">').replace('<p>[/expand]</p>','</div>'); el.parentNode.innerHTML = parentcontent; } }); var elements = document.querySelectorAll('div.expand'); Array.prototype.forEach.call(elements, function(el, i){ el.previousElementSibling.innerHTML = el.previousElementSibling.innerHTML + '<span>..&nbsp; <a href="#" style="cursor: pointer;" onclick="this.parentNode.parentNode.nextElementSibling.style.display = \'block\'; this.parentNode.parentNode.nextElementSibling.style.height = \'auto\'; this.parentNode.style.display = \'none\';">read&nbsp;more&nbsp;&rarr;</a></span>'; }); </script> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewBox="0 0 16 16"><title>Copy</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"><title>Copied</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg><div class="side-bar"><div class="site-header" role="banner"> <a href="/my-tech/" class="site-title lh-tight"> My SRE Stuff </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="/my-tech/" class="nav-list-link">My Page</a><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in AWS category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/my-tech/docs/AWS" class="nav-list-link">AWS</a><ul class="nav-list"><li class="nav-list-item "><a href="/my-tech/doc/AWS/creation-of-basic-infra/" class="nav-list-link">CloudFormation Stack Deployment Examples Part 1</a><li class="nav-list-item "><a href="/my-tech/doc/AWS/doc-2/" class="nav-list-link">Create an Infrastructure that runs redundant WordPress</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Ansible category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/my-tech/docs/Ansible" class="nav-list-link">Ansible</a><ul class="nav-list"><li class="nav-list-item "><a href="/my-tech/doc/Ansible/ansible-1/" class="nav-list-link">Create a host, ssh into the public EC2 instnace</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in CICD category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/my-tech/docs/CICD" class="nav-list-link">CICD</a><ul class="nav-list"></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Docker category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/my-tech/docs/Docker" class="nav-list-link">Docker</a><ul class="nav-list"><li class="nav-list-item "><a href="/my-tech/doc/Docker/docker-1/" class="nav-list-link">Docker First Setup From A Cloud Guru Part 1</a><li class="nav-list-item "><a href="/my-tech/doc/Docker/docker-2/" class="nav-list-link">Docker First Setup From A Cloud Guru Part 2</a></ul><li class="nav-list-item active"><button class="nav-list-expander btn-reset" aria-label="toggle items in Kubernetes category" aria-pressed="true"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/my-tech/docs/Kubernetes" class="nav-list-link">Kubernetes</a><ul class="nav-list"><li class="nav-list-item active"><a href="/my-tech/doc/Kubernetes/doc-1/" class="nav-list-link active">Kubernetes 1.24 Installation</a><li class="nav-list-item "><a href="/my-tech/doc/Kubernetes/doc-2/" class="nav-list-link">CKA Preparation, 1.22</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Misc category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/my-tech/docs/Misc" class="nav-list-link">Misc</a><ul class="nav-list"><li class="nav-list-item "><a href="/my-tech/doc/Misc/template/" class="nav-list-link">tutorial about the running a sample docker image in numbered steps</a><li class="nav-list-item "><a href="/my-tech/template/" class="nav-list-link">Title</a><li class="nav-list-item "><a href="/my-tech/doc/Misc/tutorial-about-the-running-a-sample-docker-image-in-numbered-steps%20copy/" class="nav-list-link">tutorial about the running a sample docker image in numbered steps</a><li class="nav-list-item "><a href="/my-tech/doc/Misc/a-tutorial-about-creating-an-AWS-basic-infrastructure,-with-VPC,-publicc,-and-private-subnets,-IGW,-NAT,-security-groups,-EC2-and-RDS-that-runs-postgresql/" class="nav-list-link">a tutorial about creating an AWS basic infrastructure, with VPC, public, and private subnets, IGW, NAT, security groups, EC2 and RDS that runs postgresql</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Terraform category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/my-tech/docs/Terraform" class="nav-list-link">Terraform</a><ul class="nav-list"><li class="nav-list-item "><a href="/my-tech/docs/Terraform/doc-1/" class="nav-list-link">Terraform Deployment of basic infrastructure on AWS</a></ul></ul></nav></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search" role="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search My SRE Stuff" aria-label="Search My SRE Stuff" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="/my-tech/docs/Kubernetes">Kubernetes</a><li class="breadcrumb-nav-list-item"><span>Kubernetes 1.24 Installation</span></ol></nav><div id="main-content" class="main-content"><main><h1> Kubernetes 1.24 Installation</h1><h2></h2><h3> Date Posted: 2023 02 05</h3><details> <summary>Basic Kubernetes 1.24 Installation</summary><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Install Packages</span>
<span class="c"># Containerd is needed</span>
<span class="c"># Before installing containerd load configuration files</span>
<span class="c"># Disable swap</span>
<span class="c"># Install dependency packages (apt-transport-https, curl,ca-certifcate, gnupg,  lsb-release)</span>
<span class="c"># Install kubeadm, kubectl, kubelet</span>
<span class="c"># Initialize the Cluster</span>
Sudo kubeadm init <span class="nt">--pod-network-cidr</span> 1927.168.0.0/16 <span class="nt">--kubernetes-version</span> 1.23.0
<span class="c"># Kubeconfig</span>
<span class="c"># Network Add On</span>
<span class="c"># Calico, vpc, etc.</span>
<span class="c"># Join worker nodes</span>
<span class="c"># Sudo kubeadm join </span>

<span class="c"># Upgrading kubeadm refernce: https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/</span>
<span class="c"># Upgrade the control plane</span>
<span class="c"># Check the version</span>
<span class="c"># Drain the control plane node</span>
kubectl drain node-name <span class="nt">--ignore-daemonsets</span>
<span class="c"># Upgrade kubectl kubelet</span>
		
<span class="c"># Uncordon the node</span>
<span class="c"># Upgrade the worker node</span>
<span class="c"># Upgrade kubeadm</span>
<span class="c"># $ sudo kubeadm upgrade node</span>
<span class="c"># Upgrade kubelet and kubectl</span>
<span class="c"># Restart the service</span>

<span class="c"># https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster</span>
<span class="c"># Download etcd</span>
<span class="c"># Run etcd</span>
<span class="c"># etcd --listen-client-urls=http://$IP1:2379,http://$IP2:2379,http://$IP3:2379,http://$IP4:2379,http://$IP5:2379 --advertise-client-urls=http://$IP1:2379,http://$IP2:2379,http://$IP3:2379,http://$IP4:2379,http://$IP5:2379</span>
<span class="c"># List etcd serveres</span>
<span class="c"># ETCDCTL_API=3 etcdctl --endpoints 10.2.0.9:2379 \</span>
  <span class="nt">--cert</span><span class="o">=</span>/etc/kubernetes/pki/etcd/server.crt <span class="se">\</span>
  <span class="nt">--key</span><span class="o">=</span>/etc/kubernetes/pki/etcd/server.key <span class="se">\</span>
  <span class="nt">--cacert</span><span class="o">=</span>/etc/kubernetes/pki/etcd/ca.crt <span class="se">\</span>
  member list
<span class="c"># Backup etcd</span>
<span class="c"># ETCDCTL_API=3etcdctl --endpoints $ENDPOINT snapshot save snapshotdb</span>



<span class="c">## Worker Nodes</span>
<span class="c">## From https://kubernetes.io/docs/setup/production-environment/container-runtimes/</span>
<span class="c"># containerd preinstall configuration</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee /etc/modules-load.d/containerd.conf
overlay
br_netfilter
</span><span class="no">EOF

</span><span class="nb">sudo </span>modprobe overlay
<span class="nb">sudo </span>modprobe br_netfilter

<span class="c"># Setup required sysctl params, these persist across reboots.</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
</span><span class="no">EOF

</span><span class="c"># Apply sysctl params without reboot</span>
<span class="nb">sudo </span>sysctl <span class="nt">--system</span>

<span class="c"># Install containerd</span>
<span class="c">## Set up the repository</span>
<span class="c">### Install packages to allow apt to use a repository over HTTPS</span>
<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\</span>
    apt-transport-https <span class="se">\</span>
    ca-certificates <span class="se">\</span>
    curl <span class="se">\</span>
    gnupg <span class="se">\</span>
    lsb-release

OR 

Sudo apt-get update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> containerd

<span class="c">## Add Dockerâ€™s official GPG key</span>
curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /usr/share/keyrings/docker-archive-keyring.gpg

<span class="c">## Add Docker apt repository.</span>
<span class="nb">echo</span> <span class="se">\</span>
  <span class="s2">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu </span><span class="se">\</span><span class="s2">
  </span><span class="si">$(</span>lsb_release <span class="nt">-cs</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null

<span class="c">## Install packages</span>
<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="se">\</span>
  containerd.io

<span class="c"># Configure containerd</span>
<span class="nb">sudo mkdir</span> <span class="nt">-p</span> /etc/containerd
containerd config default | <span class="nb">sudo tee</span> /etc/containerd/config.toml

<span class="c"># Restart containerd</span>
<span class="nb">sudo </span>systemctl restart containerd

Resource: https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/

<span class="c"># Update the package</span>
<span class="nb">sudo </span>apt-get update
<span class="c"># install needed packages</span>
<span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> apt-transport-https ca-certificates curl
<span class="nb">sudo </span>curl <span class="nt">-fsSLo</span> /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
<span class="nb">echo</span> <span class="s2">"deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main"</span> | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/kubernetes.list
<span class="nb">sudo </span>apt-get update
<span class="c"># Install kubelet, kubelet, and kubeadm</span>
<span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubelet</span><span class="o">=</span>1.20.7-00 <span class="nv">kubeadm</span><span class="o">=</span>1.20.7-00 <span class="nv">kubectl</span><span class="o">=</span>1.20.7-00
<span class="c"># stop automatic update for kubernetes packages</span>
<span class="nb">sudo </span>apt-mark hold kubelet kubeadm kubectl

Resource: https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/

<span class="c"># Switch to Control Plane and start kubeadm</span>
<span class="nv">$ </span><span class="nb">sudo </span>kubeadm init <span class="nt">--pod-network-cidr</span><span class="o">=</span>10.244.0.0/16 <span class="nt">--cri-socket</span> unix:///run/containerd/containerd.sock

<span class="c"># copy and paste what kubeadm output says</span>
<span class="nv">$ </span><span class="nb">sudo </span>kubeadm <span class="nb">join </span>172.16.1.11:6443 <span class="nt">--token</span> h8vno9.7eroqaei7v1isdpn <span class="se">\</span>
    <span class="nt">--discovery-token-ca-cert-hash</span> sha256:44f1def2a041f116bc024f7e57cdc0cdcc8d8f36f0b942bdd27c7f864f645407 <span class="nt">--cri-socket</span> unix:///run/containerd/containerd.sock

<span class="c"># Configure kubectl access, add kubeconfig</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$HOME</span>/.kube
<span class="nb">sudo cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
<span class="nb">sudo chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> <span class="nv">$HOME</span>/.kube/config

<span class="c"># Deploy Flannel as a network plugin</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

<span class="nv">$ </span>kubectl get nodes



https://github.com/alijahnas/CKA-practice-exercises/blob/CKA-v1.20/cluster-architecture-installation-configuration.md#:~:text<span class="o">=</span>https%3A//kubernetes.io/docs/tasks/administer%2Dcluster/kubeadm/kubeadm%2Dupgrade/

<span class="c">########## Switch to Master Node #########</span>
<span class="c"># Upgrade kubeadm</span>
<span class="nb">sudo </span>apt-mark unhold kubeadm
<span class="nb">sudo </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubeadm</span><span class="o">=</span>1.21.1-00
<span class="nb">sudo </span>apt-mark hold kubeadm

<span class="c"># Upgrade controlplane node</span>
kubectl drain k8s-controlplane <span class="nt">--ignore-daemonsets</span>
<span class="nb">sudo </span>kubeadm upgrade plan
<span class="nb">sudo </span>kubeadm upgrade apply v1.21.1

<span class="c"># Update Flannel</span>
kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

<span class="c"># Upgrade kubelet and kubectl</span>
<span class="nb">sudo </span>apt-mark unhold kubelet kubectl
<span class="nb">sudo </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubelet</span><span class="o">=</span>1.21.1-00 <span class="nv">kubectl</span><span class="o">=</span>1.21.1-00
<span class="nb">sudo </span>apt-mark hold kubelet kubectl
<span class="nb">sudo </span>systemctl daemon-reload
<span class="nb">sudo </span>systemctl restart kubelet

<span class="c"># Make master node reschedulable</span>
kubectl uncordon k8s-controlplane

<span class="c">####### Swtich to Worker Node</span>
<span class="c"># Upgrade kubeadm</span>
<span class="nb">sudo </span>apt-mark unhold kubeadm
<span class="nb">sudo </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubeadm</span><span class="o">=</span>1.21.1-00
<span class="nb">sudo </span>apt-mark hold kubeadm

<span class="c"># Upgrade worker node</span>
kubectl drain k8s-node-1 <span class="nt">--ignore-daemonsets</span>
<span class="nb">sudo </span>kubeadm upgrade node

<span class="c"># Upgrade kubelet and kubectl</span>
<span class="nb">sudo </span>apt-mark unhold kubelet kubectl
<span class="nb">sudo </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nv">kubelet</span><span class="o">=</span>1.21.1-00 <span class="nv">kubectl</span><span class="o">=</span>1.21.1-00
<span class="nb">sudo </span>apt-mark hold kubelet kubectl
<span class="nb">sudo </span>systemctl daemon-reload
<span class="nb">sudo </span>systemctl restart kubelet

<span class="c"># Make worker node reschedulable</span>
kubectl uncordon k8s-node-1

<span class="c"># Hold kubernetes from upgrading</span>
<span class="nb">sudo </span>apt-mark hold kubeadm kubelet kubectl

<span class="c"># Upgrade node</span>
kubectl drain k8s-node-1 <span class="nt">--ignore-daemonsets</span>
<span class="nb">sudo </span>apt update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt upgrade <span class="nt">-y</span> <span class="c"># Be careful about container runtime (e.g., docker) upgrade.</span>

<span class="c"># Reboot node if necessary</span>
<span class="nb">sudo </span>reboot

<span class="c"># Make worker node reschedulable</span>
kubectl uncordon k8s-node-1



https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster

<span class="c">## Check the version</span>
<span class="nv">$ </span>kubectl exec-it <span class="nt">-n</span> kube-system etcd-k8s-controlplane <span class="nt">--</span> etcd <span class="nt">--version</span>
etcd Version: 3.4.13
Git SHA: ae9734ed2
Go Version: go1.12.17
Go OS/Arch: linux/amd64

<span class="c">##  Download etcd client</span>
wget https://github.com/etcd-io/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz
<span class="nb">tar </span>xzvf etcd-v3.4.13-linux-amd64.tar.gz
<span class="nb">sudo mv </span>etcd-v3.4.13-linux-amd64/etcdctl /usr/local/bin

<span class="c">## save etcd snapshot</span>
<span class="nb">sudo </span><span class="nv">ETCDCTL_API</span><span class="o">=</span>3 etcdctl snapshot save <span class="nt">--endpoints</span> 172.16.1.11:2379 snapshot.db <span class="nt">--cacert</span> /etc/kubernetes/pki/etcd/server.crt <span class="nt">--cert</span> /etc/kubernetes/pki/etcd/ca.crt <span class="nt">--key</span> /etc/kubernetes/pki/etcd/ca.key

<span class="c"># View the snapshot</span>
<span class="nv">ETCDCTL_API</span><span class="o">=</span>3 <span class="nb">sudo </span>etcdctl <span class="nt">--write-out</span><span class="o">=</span>table snapshot status snapshot.db 
+----------+----------+------------+------------+
|   HASH   | REVISION | TOTAL KEYS | TOTAL SIZE |
+----------+----------+------------+------------+
| 4056f9fc |    18821 |        809 |     4.1 MB |
+----------+----------+------------+------------+</code></pre></figure></details></main><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><span>[ <a href="https://github.com/kyoon55">Github</a> ]</span> <span>[ <a href="mailto:kyoon5@gwu.edu">Click here to email me</a> ]</span><div class="d-flex mt-2"></div></footer></div></div><div class="search-overlay"></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="stylesheet" href="/my-tech/assets/css/just-the-docs-default.css"> <script src="/my-tech/assets/js/vendor/lunr.min.js"></script> <script src="/my-tech/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/my-tech/assets/images/favicon.ico" type="image/x-icon"><title>Kubernetes 1.24 Installation | My SRE Stuff</title><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Kubernetes 1.24 Installation" /><meta property="og:locale" content="en_US" /><meta name="description" content="This page is full of articles for my SRE knowledge" /><meta property="og:description" content="This page is full of articles for my SRE knowledge" /><link rel="canonical" href="http://localhost:4000/my-tech/doc/Kubernetes/doc-1/" /><meta property="og:url" content="http://localhost:4000/my-tech/doc/Kubernetes/doc-1/" /><meta property="og:site_name" content="My SRE Stuff" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-02-05T00:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Kubernetes 1.24 Installation" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-02-05T00:00:00-05:00","datePublished":"2023-02-05T00:00:00-05:00","description":"This page is full of articles for my SRE knowledge","headline":"Kubernetes 1.24 Installation","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/my-tech/doc/Kubernetes/doc-1/"},"url":"http://localhost:4000/my-tech/doc/Kubernetes/doc-1/"}</script>
